graph TB
    subgraph "Client Browser"
        subgraph "React Application"
            APP[App.tsx<br/>Main App Component]
            
            subgraph "Core Components"
                CANVAS[Canvas.tsx<br/>Main Canvas Orchestrator]
                CANVASOBJ[CanvasObject.tsx<br/>Rectangle Rendering]
                CANVASBG[CanvasBackground.tsx<br/>Grid & Background]
                TOOLBAR[Toolbar.tsx<br/>Tool Selection]
                PRESENCE[PresenceList.tsx<br/>Online Users]
                CURSOR[MultiplayerCursor.tsx<br/>Real-time Cursors]
                PANEL[DraggablePanel.tsx<br/>Floating Panels]
            end
            
            subgraph "Shape Components"
                CIRCLE[Circle.tsx<br/>Circle Shapes]
                LINE[Line.tsx<br/>Line Shapes]
                TEXT[Text.tsx<br/>Text Shapes]
            end
            
            subgraph "Auth Components"
                LOGIN[Login.tsx<br/>Auth Form]
                REGISTER[Register.tsx<br/>Registration]
                AUTHPROV[AuthProvider.tsx<br/>Auth Context]
            end
            
            subgraph "AI Features ðŸ¤–"
                AIINPUT[AICommandInput.tsx<br/>Command Interface]
                AIHISTORY[AICommandHistory.tsx<br/>Command History]
                AILOADING[AILoadingIndicator.tsx<br/>Loading State]
                AIERROR[AIErrorDisplay.tsx<br/>Error Display]
            end
            
            subgraph "Comments Features ðŸ’¬"
                COMMENTPIN[CommentPin.tsx<br/>Canvas Markers]
                COMMENTTHREAD[CommentThread.tsx<br/>Thread Viewer]
                COMMENTINPUT[CommentInput.tsx<br/>Comment Input]
            end
            
            subgraph "Tool Features"
                SELECTIONBOX[SelectionBox.tsx<br/>Multi-Select Box]
                SMARTGUIDES[SmartGuides.tsx<br/>Alignment Guides]
                GRIDOVERLAY[GridOverlay.tsx<br/>Visual Grid]
                SHORTCUTS[ShortcutsPanel.tsx<br/>Keyboard Help]
                ALIGNCTRL[AlignmentControls.tsx<br/>Align Tools]
                ZINDEXCTRL[ZIndexControls.tsx<br/>Layer Controls]
                CONTEXTMENU[ShapeContextMenu.tsx<br/>Right-Click Menu]
            end
            
            subgraph "Custom Hooks"
                USECANVAS[useCanvas.ts<br/>Canvas State & Pan/Zoom]
                USESHAPES[useShapes.ts<br/>Shape CRUD & Sync]
                USEPRESENCE[usePresence.ts<br/>Cursor & Presence]
                USEAUTH[useAuth.ts<br/>Authentication]
                USEAI[useAI.ts<br/>AI Command Processing]
                USESELECTION[useSelection.ts<br/>Multi-Select Logic]
                USEUNDOREDO[useUndoRedo.ts<br/>Command Pattern]
                USEGRID[useGrid.ts<br/>Grid & Snapping]
                USEKEYBOARD[useKeyboardShortcuts.ts<br/>Keyboard Shortcuts]
                USEZINDEX[useZIndex.ts<br/>Z-Index Management]
                USEALIGNMENT[useAlignment.ts<br/>Alignment Logic]
                USECOMMENTS[useComments.ts<br/>Comments State]
            end
            
            subgraph "Services Layer"
                FIRESERVICE[firebase.ts<br/>Firebase Init Firestore and RTDB]
                CANVASSERV[canvasService.ts<br/>Canvas Initialization]
                SHAPESERV[shapesService.ts<br/>Shape CRUD Operations]
                PRESENCESERV[presenceService.ts<br/>Presence Management]
                REALTIMECURSOR[realtimeCursorService.ts<br/>RTDB Cursor Updates]
                REALTIMEOBJ[realtimeObjectService.ts<br/>RTDB Object Dragging]
                COMMANDSERV[commandService.ts<br/>Undo/Redo Commands]
                AISERVICE[aiService.ts<br/>AI API Client]
                COMMENTSERV[commentsService.ts<br/>Comments CRUD]
            end
            
            subgraph "Utils"
                HELPERS[canvasHelpers.ts<br/>Coordinate Utils]
                SELHELPERS[selectionHelpers.ts<br/>Selection Utils]
                CLIPHELPERS[clipboardHelpers.ts<br/>Copy/Paste Utils]
                AIHELPERS[aiHelpers.ts<br/>AI Command Utils]
            end
            
            subgraph "Type Definitions"
                SHAPETYPES[shapes.ts<br/>Shape Types]
                COMMANDTYPES[commands.ts<br/>Command Types]
                AITYPES[ai.ts<br/>AI Types]
                COMMENTTYPES[comments.ts<br/>Comment Types]
            end
        end
        
        subgraph "Rendering Layer ðŸŽ¨"
            KONVA[Konva.js and React-Konva<br/>High-Performance Canvas]
        end
    end
    
    subgraph "Vercel Serverless"
        VERCELAPI[API: ai/command.ts<br/>AI Endpoint Handler]
    end
    
    subgraph "External AI Services"
        OPENAI[OpenAI GPT-4o-mini<br/>Natural Language Processing]
    end
    
    subgraph "Firebase Cloud Services"
        subgraph "Firebase Authentication"
            FBAUTH[Firebase Auth<br/>Email/Password and Sessions]
        end
        
        subgraph "Cloud Firestore (Persistent Storage) ðŸ“Š"
            USERS[("users/<br/>User Profiles")]
            CANVASDB[("canvas/shared/<br/>Canvas Metadata")]
            SHAPES[("canvas/shared/shapes/<br/>Shape Documents")]
            COMMENTS[("canvasComments/<br/>Comments & Replies")]
        end
        
        subgraph "Realtime Database (Ultra-Low Latency) âš¡"
            RTDBPRESENCE[("presence/<br/>Live Cursors")]
            RTDBMOVEMENT[("objectMovements/<br/>Dragging Positions")]
        end
        
        subgraph "Firebase Hosting (Alternative)"
            HOSTING[Static File Hosting<br/>CDN Distribution]
        end
    end
    
    subgraph "Development & Testing"
        VITEST[Vitest and React Testing Library]
        UNITTESTS[Unit Tests<br/>Services, Hooks, Utils]
    end
    
    subgraph "Build & Deploy Tools"
        VITE[Vite<br/>Build & Dev Server]
        VERCEL[Vercel<br/>Primary Hosting and Serverless]
        FIREBASE[Firebase CLI<br/>Rules & Indexes Deploy]
    end
    
    %% Component Relationships
    APP --> CANVAS
    APP --> AUTHPROV
    APP --> TOOLBAR
    APP --> PRESENCE
    
    CANVAS --> CANVASOBJ
    CANVAS --> CANVASBG
    CANVAS --> CIRCLE
    CANVAS --> LINE
    CANVAS --> TEXT
    CANVAS --> CURSOR
    CANVAS --> COMMENTPIN
    CANVAS --> SELECTIONBOX
    CANVAS --> SMARTGUIDES
    CANVAS --> GRIDOVERLAY
    CANVAS --> CONTEXTMENU
    
    CANVAS --> USECANVAS
    CANVAS --> USESHAPES
    CANVAS --> USESELECTION
    CANVAS --> USEUNDOREDO
    CANVAS --> USEGRID
    CANVAS --> USEKEYBOARD
    CANVAS --> USEZINDEX
    CANVAS --> USEALIGNMENT
    CANVAS --> USECOMMENTS
    
    CANVASOBJ --> KONVA
    CIRCLE --> KONVA
    LINE --> KONVA
    TEXT --> KONVA
    CURSOR --> KONVA
    COMMENTPIN --> KONVA
    CANVASBG --> KONVA
    GRIDOVERLAY --> KONVA
    SMARTGUIDES --> KONVA
    SELECTIONBOX --> KONVA
    
    CURSOR --> USEPRESENCE
    PRESENCE --> USEPRESENCE
    
    AUTHPROV --> LOGIN
    AUTHPROV --> REGISTER
    AUTHPROV --> USEAUTH
    
    %% AI Component Flow
    CANVAS --> PANEL
    PANEL --> AIINPUT
    PANEL --> AIHISTORY
    PANEL --> AILOADING
    PANEL --> AIERROR
    AIINPUT --> USEAI
    USEAI --> AISERVICE
    AISERVICE --> VERCELAPI
    VERCELAPI --> OPENAI
    
    %% Comments Flow
    PANEL --> COMMENTTHREAD
    COMMENTPIN --> USECOMMENTS
    COMMENTTHREAD --> USECOMMENTS
    COMMENTINPUT --> USECOMMENTS
    USECOMMENTS --> COMMENTSERV
    
    %% Undo/Redo Flow
    USEUNDOREDO --> COMMANDSERV
    COMMANDSERV --> SHAPESERV
    
    %% Hook to Service Relationships
    USECANVAS --> HELPERS
    USECANVAS --> CANVASSERV
    
    USESHAPES --> SHAPESERV
    USESHAPES -.Real-time Listener.-> SHAPES
    
    USEPRESENCE --> PRESENCESERV
    USEPRESENCE --> REALTIMECURSOR
    USEPRESENCE -.Real-time Listener.-> RTDBPRESENCE
    
    USEAUTH --> FIRESERVICE
    USEAUTH --> FBAUTH
    
    USESELECTION --> SELHELPERS
    
    USEGRID --> HELPERS
    
    USECOMMENTS --> COMMENTSERV
    USECOMMENTS -.Real-time Listener.-> COMMENTS
    
    %% Service to Firebase Relationships
    FIRESERVICE --> FBAUTH
    FIRESERVICE --> USERS
    
    CANVASSERV --> FIRESERVICE
    CANVASSERV --> CANVASDB
    
    SHAPESERV --> FIRESERVICE
    SHAPESERV --> SHAPES
    SHAPESERV --> REALTIMEOBJ
    
    PRESENCESERV --> FIRESERVICE
    PRESENCESERV --> REALTIMECURSOR
    PRESENCESERV --> RTDBPRESENCE
    
    REALTIMECURSOR --> RTDBPRESENCE
    REALTIMEOBJ --> RTDBMOVEMENT
    
    COMMENTSERV --> FIRESERVICE
    COMMENTSERV --> COMMENTS
    
    AISERVICE --> AIHELPERS
    
    %% Real-time Sync Flows
    SHAPES -.onSnapshot.-> USESHAPES
    RTDBPRESENCE -.onValue.-> USEPRESENCE
    RTDBMOVEMENT -.onValue.-> USESHAPES
    COMMENTS -.onSnapshot.-> USECOMMENTS
    
    %% Authentication Flow
    FBAUTH -.Auth State.-> USEAUTH
    
    %% Testing Relationships
    VITEST --> UNITTESTS
    UNITTESTS -.Tests.-> FIRESERVICE
    UNITTESTS -.Tests.-> CANVASSERV
    UNITTESTS -.Tests.-> SHAPESERV
    UNITTESTS -.Tests.-> PRESENCESERV
    UNITTESTS -.Tests.-> USEAUTH
    UNITTESTS -.Tests.-> USESHAPES
    UNITTESTS -.Tests.-> USEPRESENCE
    UNITTESTS -.Tests.-> HELPERS
    UNITTESTS -.Tests.-> SELHELPERS
    UNITTESTS -.Tests.-> AIHELPERS
    
    %% Build & Deploy Pipeline
    VITE --> VERCEL
    FIREBASE --> FBAUTH
    FIREBASE --> SHAPES
    FIREBASE --> COMMENTS
    FIREBASE --> RTDBPRESENCE
    
    %% Styling
    classDef component fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef hook fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef firebase fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef database fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef rtdb fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    classDef tool fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef test fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef ai fill:#fff4e6,stroke:#ff8f00,stroke-width:3px
    classDef external fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef comments fill:#e3f2fd,stroke:#0d47a1,stroke-width:2px
    classDef types fill:#fafafa,stroke:#424242,stroke-width:1px,stroke-dasharray: 5 5
    
    class CANVAS,CANVASOBJ,CANVASBG,TOOLBAR,PRESENCE,CURSOR,LOGIN,REGISTER,AUTHPROV,APP,PANEL,CIRCLE,LINE,TEXT component
    class AIINPUT,AIHISTORY,AILOADING,AIERROR ai
    class COMMENTPIN,COMMENTTHREAD,COMMENTINPUT comments
    class SELECTIONBOX,SMARTGUIDES,GRIDOVERLAY,SHORTCUTS,ALIGNCTRL,ZINDEXCTRL,CONTEXTMENU tool
    class USECANVAS,USESHAPES,USEPRESENCE,USEAUTH,USEAI,USESELECTION,USEUNDOREDO,USEGRID,USEKEYBOARD,USEZINDEX,USEALIGNMENT,USECOMMENTS hook
    class FIRESERVICE,CANVASSERV,SHAPESERV,PRESENCESERV,REALTIMECURSOR,REALTIMEOBJ,COMMANDSERV,AISERVICE,COMMENTSERV,HELPERS,SELHELPERS,CLIPHELPERS,AIHELPERS service
    class FBAUTH,HOSTING firebase
    class USERS,CANVASDB,SHAPES,COMMENTS database
    class RTDBPRESENCE,RTDBMOVEMENT rtdb
    class VITE,VERCEL,FIREBASE,KONVA tool
    class VITEST,UNITTESTS test
    class OPENAI,VERCELAPI external
    class SHAPETYPES,COMMANDTYPES,AITYPES,COMMENTTYPES types
